-- Note: all_sessions.sqlpp should be run before this script.
CREATE OR REPLACE FUNCTION `[BUCKET_NAME]`.`[SCOPE_NAME]`.QueryToolCalls(){
(
SELECT
    s1.sid AS sid,
    s1.vid AS vid,
    tool_calls AS tool_calls
FROM
    `[BUCKET_NAME]`.`[SCOPE_NAME]`.QuerySessions() AS s1,
    s1.msgs AS m1,
    m1.content.dump.kwargs.tool_calls AS tc1,
    `[BUCKET_NAME]`.`[SCOPE_NAME]`.QuerySessions() AS s2,
    s2.msgs AS m2
WHERE
    m1.kind = "llm" AND
    m2.kind = "tool" AND
    tc1.id = m2.content.dump.kwargs.tool_call_id
GROUP BY
    s1, s2
GROUP AS
    g
LETTING
    tool_calls = (
        FROM
            g AS gi
        SELECT
            gi.tc1.name AS tool_name,
            gi.tc1.args AS tool_args,
            gi.tc1.id AS tool_call_id,
            gi.m2.content.dump.kwargs.content AS tool_result,
            gi.m2.content.dump.kwargs.status AS tool_status
    )
ORDER BY
    STR_TO_MILLIS(vid.timestamp) DESC
)
};