-- Note: all_sessions.sqlpp should be run before this script.
CREATE OR REPLACE FUNCTION `[BUCKET_NAME]`.`[SCOPE_NAME]`.QueryLatestMessages() {
(
WITH LM AS
(
WITH msgs AS (
    SELECT
        s.content.content AS content,
        s.content.tool_calls AS tool_calls,
        s.kind,
        s.timestamp,
        s.grouping,
        s.session,
        ROW_NUMBER() OVER (PARTITION BY s.grouping, s.session ORDER BY STR_TO_MILLIS(s.timestamp)) AS row_num
    FROM `[BUCKET_NAME]`.`[SCOPE_NAME]`.`[LOG_COLLECTION_NAME]` AS s
    WHERE s.grouping IS NOT NULL
),
first_human AS (
    SELECT msgsi.row_num
    FROM msgs AS msgsi
    WHERE msgsi.kind = "human"
    ORDER BY STR_TO_MILLIS(msgsi.timestamp) ASC
    LIMIT 1
),
last_message AS (
    SELECT msgsi.row_num
    FROM msgs AS msgsi
    ORDER BY STR_TO_MILLIS(msgsi.timestamp) DESC
    LIMIT 1
)
SELECT
    (SELECT RAW msgsi.content
     FROM msgs AS msgsi
     WHERE msgsi.kind = "human"
     AND msgsi.grouping = g.grouping
     AND msgsi.session = g.session
     ORDER BY STR_TO_MILLIS(msgsi.timestamp) ASC
     LIMIT 1) AS question,

    (SELECT RAW COALESCE(msgsi.content, msgsi.tool_calls)
     FROM msgs AS msgsi
     WHERE msgsi.grouping = g.grouping
     AND msgsi.session = g.session
     ORDER BY STR_TO_MILLIS(msgsi.timestamp) DESC
     LIMIT 1) AS answer,

    (SELECT RAW COALESCE(msgsi.content, msgsi.tool_calls)
     FROM msgs AS msgsi
     WHERE msgsi.grouping = g.grouping
     AND msgsi.session = g.session
     AND msgsi.row_num != (SELECT RAW row_num FROM first_human)
     AND msgsi.row_num != (SELECT RAW row_num FROM last_message)
    ) AS contexts,

    ROW_NUMBER() OVER () AS row_num
FROM (SELECT DISTINCT grouping, session FROM msgs) AS g
)
SELECT
(FROM LM e SELECT VALUE e.question ORDER BY e.row_num) AS question,
(FROM LM e SELECT VALUE e.answer ORDER BY e.row_num) AS answer,
(FROM LM e SELECT VALUE e.contexts ORDER BY e.row_num) AS contexts
)
};