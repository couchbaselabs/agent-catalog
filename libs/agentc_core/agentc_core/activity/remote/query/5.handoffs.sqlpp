CREATE OR REPLACE FUNCTION `[BUCKET_NAME]`.`[SCOPE_NAME]`.Handoffs() {
    (
        FROM
            `[BUCKET_NAME]`.`[SCOPE_NAME]`.`[LOG_COLLECTION_NAME]` AS l
        WHERE
            l.content.kind IN ["begin", "end"]
        GROUP BY
            l.content.state,
            l.span.session,
            l.span.name[0:-1]
            GROUP AS g
        LETTING
            source = (
                FROM
                    g AS gi
                WHERE
                    gi.l.content.kind = "end"
                SELECT VALUE
                    gi.l.span.name[-1]
            )[0],
            dest = (
                FROM
                    g AS gi
                WHERE
                    gi.l.content.kind = "begin"
                SELECT VALUE
                    gi.l.span.name[-1]
            )[0],
            timestamp = (
                FROM
                    g AS gi
                WHERE
                    gi.l.content.kind = "begin"
                SELECT VALUE
                    gi.l.timestamp
            )[0]
        HAVING
            COUNT(*) > 1 AND
            source != dest
        SELECT
            l.span.session    AS sid,
            l.span.name[0:-1] AS parent,
            source            AS source,
            dest              AS dest,
            timestamp         AS timestamp
    )
};
